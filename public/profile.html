<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library NoSQL · User Profile</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <nav>
        <div class="brand">
            <div class="brand-title">Library NoSQL</div>
            <div class="brand-tagline">MongoDB-powered community catalog</div>
        </div>

        <div class="nav-section-label">Main</div>
        <div class="nav-links">
            <a href="index.html">
                <span class="icon"></span>
                <span>Dashboard</span>
            </a>
            <a href="catalog.html">
                <span class="icon"></span>
                <span>Book Catalog</span>
            </a>
            <a href="add-book.html">
                <span class="icon"></span>
                <span>Add New Book</span>
            </a>
            <a href="details.html">
                <span class="icon"></span>
                <span>Reviews &amp; Details</span>
            </a>
            <a href="profile.html" class="active">
                <span class="icon"></span>
                <span>User Profile</span>
            </a>
        </div>
    </nav>

    <main>
        <header class="page-header">
            <div class="page-meta">User</div>
            <h1>User profile &amp; activity</h1>
            <p>
                Shows referenced data from a <strong>Loans</strong> collection and demonstrates
                updating a user document using MongoDB's <strong>$set</strong> operator.
            </p>
        </header>

        <section class="card-grid">
            <article class="card stack-lg">
                <div class="stack">
                    <h2>Active loans (referenced data)</h2>
                    <p class="muted-text">
                        Pulled from <span class="pill">GET /api/users/:id/loans</span> using a static
                        user ID to simulate authentication.
                    </p>
                </div>

                <div id="loans-list" class="stack" style="margin-top: 6px;">
                    <span class="muted-text">Loading active loans…</span>
                </div>
            </article>

            <article class="card stack-lg">
                <div class="stack">
                    <h2>Update profile settings ($set)</h2>
                    <p class="muted-text">
                        Sends a <span class="pill">PUT /api/users/:id</span> request and updates the
                        <code>username</code> field via <strong>$set</strong>.
                    </p>
                </div>

                <div class="stack">
                    <label for="username">New username</label>
                    <input type="text" id="username" placeholder="e.g. library-admin" />
                </div>

                <div class="stack-row" style="justify-content: flex-end;">
                    <button class="btn btn-primary" type="button" onclick="updateUser()">
                        Update username
                    </button>
                </div>
            </article>
        </section>
    </main>

    <script>

        const currentUserId = "65a1234567890abcdef12345"; 

        async function loadUserLoans() {
            try {

                const res = await fetch(`http://localhost:3000/api/users/${currentUserId}/loans`);
                const loans = await res.json();
                const container = document.getElementById('loans-list');
                
                if (!Array.isArray(loans) || loans.length === 0) {
                    container.innerHTML = "<span class='muted-text'>No active loans found.</span>";
                    return;
                }

                container.innerHTML = loans.map(loan => `
                    <div class="stack" style="padding: 10px 0; border-bottom: 1px solid #eee;">
                        <strong>Book ID:</strong> ${loan.bookId} <br>
                        <strong>Due Date:</strong> ${new Date(loan.dueDate).toLocaleDateString()}
                    </div>
                `).join('');
            } catch (err) {
                console.error("Error loading loans:", err);
                const container = document.getElementById('loans-list');
                container.innerHTML = "<span class='muted-text'>Unable to load loans. Is the backend running?</span>";
            }
        }

        async function updateUser() {
            const newName = document.getElementById('username').value.trim();

            if (!newName) {
                alert("Please enter a username first.");
                return;
            }

            // Demonstrates Advanced Update Operator usage [cite: 31, 35]
            await fetch(`http://localhost:3000/api/users/${currentUserId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: newName })
            });
            alert("Username updated in MongoDB using $set!");
        }

        loadUserLoans();
    </script>
</body>
</html>