<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library NoSQL · Catalog</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <nav>
        <div class="brand">
            <div class="brand-title">Library NoSQL</div>
            <div class="brand-tagline">MongoDB-powered community catalog</div>
        </div>

        <div class="nav-section-label">Main</div>
        <div class="nav-links">
            <a href="index.html">
                <span class="icon"></span>
                <span>Dashboard</span>
            </a>
            <a href="catalog.html" class="active">
                <span class="icon"></span>
                <span>Book Catalog</span>
            </a>
            <a href="add-book.html">
                <span class="icon"></span>
                <span>Add New Book</span>
            </a>
            <a href="details.html">
                <span class="icon"></span>
                <span>Reviews &amp; Details</span>
            </a>
            <a href="profile.html">
                <span class="icon"></span>
                <span>User Profile</span>
            </a>
        </div>
    </nav>

    <main>
        <header class="page-header">
            <div class="page-meta">Collection</div>
            <div class="page-title-row">
                <h1>Book catalog</h1>
                <div class="actions">
                    <button class="btn btn-primary" type="button" onclick="window.location.href='add-book.html'">
                        Add book
                    </button>
                </div>
            </div>
            <p>Browse and manage all books stored in your MongoDB collection.</p>
        </header>

        <section class="card">
            <div class="stack-row" style="justify-content: space-between; margin-bottom: 8px;">
                <span class="muted-text">
                    Data loaded from <span class="pill">GET /api/books</span>.
                </span>
                <button class="btn btn-ghost" type="button" onclick="loadBooks()">
                    Refresh
                </button>
            </div>

            <div id="book-container" class="book-list">
                <div class="book-row">
                    <div class="book-meta">Loading books…</div>
                </div>
            </div>
        </section>
    </main>

    <script>
        async function loadBooks() {
            const container = document.getElementById('book-container');
            container.innerHTML =
                '<div class="book-row"><div class="book-meta">Loading books…</div></div>';

            try {
                const res = await fetch('/api/books');
                const books = await res.json();

                if (!Array.isArray(books) || books.length === 0) {
                    container.innerHTML =
                        '<div class="book-row"><div class="book-meta">No books yet. Try adding one.</div></div>';
                    return;
                }

                container.innerHTML = books
                    .map(
                        (b) => `
                    <div class="book-row">
                        <div>
                            <h3>${b.title}</h3>
                            <div class="book-meta">
                                Genre: ${b.genre || '—'}
                                &nbsp;·&nbsp;
                                Views: ${b.views || 0}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteBook('${b._id}')">
                            Delete
                        </button>
                    </div>
                `
                    )
                    .join('');
            } catch (err) {
                console.error(err);
                container.innerHTML =
                    '<div class="book-row"><div class="book-meta">Unable to load books. Is the backend running?</div></div>';
            }
        }

        async function deleteBook(id) {
            if (!confirm('Are you sure you want to delete this book?')) return;

            try {
                // Note: Admin key required as per the isAdmin middleware in server.js
                await fetch(`/api/books/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-api-key': 'admin-secret-token' },
                });
                loadBooks();
            } catch (err) {
                console.error(err);
                alert('Failed to delete book. Check the server logs.');
            }
        }

        loadBooks();
    </script>
</body>
</html>